name: Tarea Diaria de Scripts

on:
  schedule:
    - cron: '0 9 * * *' 
  workflow_dispatch: 

jobs:
  ejecutar_script:
    runs-on: ubuntu-latest 
    
    permissions:
      contents: write

    steps:
    - name: 1. Checkout del código
      uses: actions/checkout@v4 
    
    - name: 2. Configurar Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10' 

    - name: 3. Instalar dependencias
      run: |
        pip install yfinance pandas
        
    - name: 4. Ejecutar Script principal
      # Esto crea el archivo 'ejecuciones_log.txt' en la VM
      run: python tu_script.py

    - name: 5. Debugging - Listar Archivos
      run: ls -lha  

    # NUEVO PASO: Enviar el Log a Telegram
    - name: 6. Enviar Log a Telegram
      # Solo enviar si el script (paso 4) fue exitoso
      if: success()
      run: |
        # 1. Leer el contenido del log
        LOG_CONTENT=$(cat ejecuciones_log.txt)
        
        # 2. Crear el mensaje final. Usamos 'MarkdownV2' para el formato.
        # Envolviendo el log en tres comillas inversas (```) lo formatea como código
        MENSAJE="*✅ Reporte de Script Diario*\n\n\`\`\`\n$LOG_CONTENT\n\`\`\`"
        
        # 3. Enviar la notificación vía Telegram API (usando curl)
        # --data-urlencode es clave para manejar espacios y caracteres especiales en el log
        curl -s -X POST "[https://api.telegram.org/bot$](https://api.telegram.org/bot$){{ secrets.TELEGRAM_TOKEN }}/sendMessage" \
          -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
          --data-urlencode "text=$MENSAJE" \
          -d "parse_mode=MarkdownV2"

    - name: 6. Guardar cambios (Git Scraping)
      run: |
        git config user.name "Automated Action"
        git config user.email "actions@users.noreply.github.com"
        
        git add ejecuciones_log.txt
        
        # Si el log se envió correctamente, hacemos commit
        git commit -m "Auto: Actualización de log diario y Telegram enviado" || exit 0
        
        git push
